workflows:
  ios-workflow:
    name: RatoNet iOS Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      vars:
        XCODE_WORKSPACE: "RatoNet.xcodeproj"
        XCODE_SCHEME: "RatoNet"
        BUNDLE_ID: "com.eerimoq.Mobs"
        # Desabilitar plugins de pacotes para evitar erro de valida√ß√£o do PrepareLicenseList
        SWIFT_PACKAGE_PLUGIN_DISABLE: "1"
        XCODE_SKIP_PACKAGE_PLUGIN_VALIDATION: "1"
      xcode: latest
    scripts:
      - name: Install dependencies
        script: |
          # Instalar SwiftLint e SwiftFormat se necess√°rio
          brew install swiftlint swiftformat || true
      - name: Resolve Swift packages
        script: |
          # Desabilitar plugins de pacotes para evitar erro de valida√ß√£o
          export SWIFT_PACKAGE_PLUGIN_DISABLE=1
          xcodebuild -resolvePackageDependencies -project "$XCODE_WORKSPACE" -scheme "$XCODE_SCHEME" -skipPackagePluginValidation
      - name: Fix Watch app product name and remove plugin dependency
        script: |
          # Modificar temporariamente o project.pbxproj para:
          # 1. Corrigir PRODUCT_NAME do RatoNetWatch
          # 2. Remover depend√™ncia do plugin PrepareLicenseList que est√° causando erro de valida√ß√£o
          python3 << 'EOF'
          import re
          
          project_file = "RatoNet.xcodeproj/project.pbxproj"
          
          with open(project_file, 'r', encoding='utf-8') as f:
              content = f.read()
          
          original_content = content
          changes_made = []
          
          # 1. Substituir PRODUCT_NAME = RatoNet; que est√° antes de SDKROOT = watchos;
          pattern1 = r'(PRODUCT_NAME = RatoNet;\s+SDKROOT = watchos;)'
          replacement1 = r'PRODUCT_NAME = RatoNetWatchApp;\n\t\t\t\tSDKROOT = watchos;'
          
          if re.search(pattern1, content):
              content = re.sub(pattern1, replacement1, content)
              changes_made.append("PRODUCT_NAME do RatoNetWatch modificado")
          else:
              pattern1_alt = r'(PRODUCT_NAME = RatoNet;[\s\n]+SDKROOT = watchos;)'
              if re.search(pattern1_alt, content):
                  content = re.sub(pattern1_alt, replacement1, content)
                  changes_made.append("PRODUCT_NAME do RatoNetWatch modificado")
          
          # 2. Remover o bloco completo do PBXTargetDependency que referencia PrepareLicenseList
          # Formato exato: IDENTIFIER /* PBXTargetDependency */ = { isa = PBXTargetDependency; productRef = IDENTIFIER /* PrepareLicenseList */; };
          pattern2 = r'\t\t\t[0-9A-F]+ /\* PBXTargetDependency \*/ = \{\s*isa = PBXTargetDependency;\s*productRef = [0-9A-F]+ /\* PrepareLicenseList \*/;\s*\};?\n'
          if re.search(pattern2, content):
              content = re.sub(pattern2, '', content)
              changes_made.append("Depend√™ncia do plugin PrepareLicenseList removida")
          
          # 3. Remover a defini√ß√£o do produto do plugin
          pattern3 = r'\t\t\t[0-9A-F]+ /\* PrepareLicenseList \*/ = \{\s*isa = XCSwiftPackageProductDependency;\s*package = [0-9A-F]+ /\* XCRemoteSwiftPackageReference "LicenseList" \*/;\s*productName = "plugin:PrepareLicenseList";\s*\};?\n'
          if re.search(pattern3, content):
              content = re.sub(pattern3, '', content)
              changes_made.append("Defini√ß√£o do produto PrepareLicenseList removida")
          
          if content != original_content:
              with open(project_file, 'w', encoding='utf-8') as f:
                  f.write(content)
              print("‚úÖ Modifica√ß√µes aplicadas:")
              for change in changes_made:
                  print(f"   - {change}")
          else:
              print("‚ö†Ô∏è  Nenhuma modifica√ß√£o necess√°ria (pode j√° estar aplicada)")
          EOF
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Build ipa for distribution
        script: |
          # Solu√ß√£o: Fazer archive do scheme principal
          # Limpar derived data para evitar problemas de cache de m√≥dulos
          mkdir -p build
          rm -rf build/DerivedData || true
          
          # Desabilitar plugins de pacotes para evitar erro de valida√ß√£o do PrepareLicenseList
          export SWIFT_PACKAGE_PLUGIN_DISABLE=1
          
          # Baixar componentes necess√°rios do Xcode
          echo "üì• Baixando Metal Toolchain..."
          xcodebuild -downloadComponent MetalToolchain || true
          
          echo "üì• Baixando plataforma iOS..."
          xcodebuild -downloadPlatform iOS || true
          
          # Remover temporariamente a depend√™ncia do Watch app antes do archive
          # O Watch app √© watchOS e n√£o pode ser arquivado junto com iOS
          python3 << 'EOF'
          import re
          
          project_file = "RatoNet.xcodeproj/project.pbxproj"
          
          with open(project_file, 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Fazer backup
          with open(project_file + '.backup', 'w', encoding='utf-8') as f:
              f.write(content)
          
          # Remover "Embed Watch Content" do buildPhases do target RatoNet
          # Procurar por: 03ECDF572B8E4E6000BD920E /* Embed Watch Content */,
          pattern1 = r'\t\t\t\t03ECDF572B8E4E6000BD920E /\* Embed Watch Content \*/,\n'
          content = re.sub(pattern1, '', content)
          
          # Remover a depend√™ncia do Watch app (PBXTargetDependency)
          # Procurar por: 03ECDF522B8E4E6000BD920E /* PBXTargetDependency */,
          pattern2 = r'\t\t\t\t03ECDF522B8E4E6000BD920E /\* PBXTargetDependency \*/,\n'
          content = re.sub(pattern2, '', content)
          
          with open(project_file, 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("‚úÖ Depend√™ncia do Watch app removida temporariamente para o archive")
          EOF
          
          # Primeiro, fazer build completo do scheme para garantir que todas as depend√™ncias
          # sejam constru√≠das na ordem correta (SDWebImage antes de SDWebImageWebPCoder)
          xcodebuild \
            -project "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            -skipPackagePluginValidation \
            SKIP_INSTALL=YES \
            build || true
          
          # Agora fazer o archive usando -scheme (obrigat√≥rio quando usa -archivePath)
          echo "üì¶ Criando archive..."
          set +e  # N√£o sair imediatamente em caso de erro
          xcodebuild \
            -project "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/RatoNet.xcarchive \
            -derivedDataPath build/DerivedData \
            -skipPackagePluginValidation \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            archive 2>&1 | tee build/archive.log
          ARCHIVE_EXIT_CODE=$?
          set -e
          
          # Verificar se o archive foi criado
          if [ -d "build/RatoNet.xcarchive" ]; then
              echo "‚úÖ Archive criado com sucesso em build/RatoNet.xcarchive"
          else
              echo "‚ùå Archive n√£o foi criado"
              echo "üìã √öltimas linhas do log de archive:"
              tail -50 build/archive.log || true
              # Restaurar o backup antes de sair
              if [ -f "RatoNet.xcodeproj/project.pbxproj.backup" ]; then
                  mv "RatoNet.xcodeproj/project.pbxproj.backup" "RatoNet.xcodeproj/project.pbxproj"
              fi
              exit 1
          fi
          
          # Se o comando falhou mas o archive existe, continuar
          if [ $ARCHIVE_EXIT_CODE -ne 0 ]; then
              echo "‚ö†Ô∏è  Comando de archive retornou c√≥digo $ARCHIVE_EXIT_CODE, mas archive existe. Continuando..."
          fi
          
          # Restaurar o backup do project.pbxproj
          if [ -f "RatoNet.xcodeproj/project.pbxproj.backup" ]; then
              mv "RatoNet.xcodeproj/project.pbxproj.backup" "RatoNet.xcodeproj/project.pbxproj"
              echo "‚úÖ Depend√™ncia do Watch app restaurada"
          fi
      - name: Export IPA
        script: |
          # Verificar se o archive existe antes de exportar
          if [ ! -d "build/RatoNet.xcarchive" ]; then
              echo "‚ùå Archive n√£o encontrado em build/RatoNet.xcarchive"
              echo "üìÇ Procurando archives em outros locais..."
              find . -name "*.xcarchive" -type d 2>/dev/null | head -5
              exit 1
          fi
          
          echo "üì¶ Extraindo IPA do archive..."
          echo "üìÇ Estrutura do archive:"
          find build/RatoNet.xcarchive -type d -maxdepth 3 | head -20
          
          mkdir -p build/ipa
          
          # Procurar o .app em diferentes locais poss√≠veis
          APP_PATH=""
          
          # Tentar diferentes caminhos
          if [ -d "build/RatoNet.xcarchive/Products/Applications" ]; then
              APP_PATH=$(find build/RatoNet.xcarchive/Products/Applications -name "*.app" -type d | head -1)
          fi
          
          if [ -z "$APP_PATH" ] && [ -d "build/RatoNet.xcarchive/Products" ]; then
              APP_PATH=$(find build/RatoNet.xcarchive/Products -name "*.app" -type d | head -1)
          fi
          
          if [ -z "$APP_PATH" ]; then
              APP_PATH=$(find build/RatoNet.xcarchive -name "*.app" -type d | head -1)
          fi
          
          if [ -z "$APP_PATH" ]; then
              echo "‚ùå N√£o foi poss√≠vel encontrar o .app no archive"
              echo "üìÇ Conte√∫do do archive:"
              ls -la build/RatoNet.xcarchive/
              if [ -d "build/RatoNet.xcarchive/Products" ]; then
                  echo "üìÇ Conte√∫do de Products:"
                  ls -la build/RatoNet.xcarchive/Products/
              fi
              exit 1
          fi
          
          echo "üì± App encontrado: $APP_PATH"
          
          # Criar o Payload directory
          PAYLOAD_DIR="build/ipa/Payload"
          mkdir -p "$PAYLOAD_DIR"
          
          # Copiar o .app para Payload
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"
          
          # Criar o IPA
          IPA_NAME="RatoNet.ipa"
          cd build/ipa
          zip -r "$IPA_NAME" Payload
          cd ../..
          
          # Verificar se o IPA foi criado
          if [ ! -f "build/ipa/$IPA_NAME" ]; then
              echo "‚ùå IPA n√£o foi criado"
              exit 1
          fi
          
          echo "‚úÖ IPA criado com sucesso: build/ipa/$IPA_NAME"
          ls -lh build/ipa/*.ipa
    artifacts:
      - build/ipa/*.ipa
      - build/*.dSYM.zip
    publishing:
      email:
        recipients:
          - user@example.com # Substitua pelo seu email
        notify:
          success: true
          failure: false
      # Descomente se quiser publicar no App Store Connect
      # app_store_connect:
      #   auth: integration
      #   submit_to_testflight: false
      #   beta_groups:
      #     - group name 1
      #     - group name 2

